# Задание

на имеющемся образе (centos/7 1804.2)
https://gitlab.com/otus_linux/stands-03-lvm

/dev/mapper/VolGroup00-LogVol00 38G 738M 37G 2% /

уменьшить том под / до 8G
выделить том под /home
выделить том под /var (/var - сделать в mirror)
для /home - сделать том для снэпшотов
прописать монтирование в fstab (попробовать с разными опциями и разными файловыми системами на выбор)
Работа со снапшотами:
сгенерировать файлы в /home/
снять снэпшот
удалить часть файлов
восстановиться со снэпшота

(залоггировать работу можно утилитой script, скриншотами и т.п.)

Задание со звездочкой*
на нашей куче дисков попробовать поставить btrfs/zfs:
с кешем и снэпшотами
разметить здесь каталог /opt

## Что было сделано

По результатам проделанной работы в соотвествии с методичкой структура дисков была преобразована следующим образом:

```BASH
[vagrant@lvm ~]$ lsblk
NAME                       MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda                          8:0    0   40G  0 disk 
├─sda1                       8:1    0    1M  0 part 
├─sda2                       8:2    0    1G  0 part /boot
└─sda3                       8:3    0   39G  0 part 
  ├─VolGroup00-LogVol00    253:0    0    8G  0 lvm  /
  ├─VolGroup00-LogVol01    253:1    0  1.5G  0 lvm  [SWAP]
  └─VolGroup00-LogVol_Home 253:4    0    2G  0 lvm  /home
sdb                          8:16   0   10G  0 disk 
sdc                          8:32   0    2G  0 disk 
├─vg_var-lv_var_rmeta_0    253:2    0    4M  0 lvm  
│ └─vg_var-lv_var          253:7    0  952M  0 lvm  /var
└─vg_var-lv_var_rimage_0   253:3    0  952M  0 lvm  
  └─vg_var-lv_var          253:7    0  952M  0 lvm  /var
sdd                          8:48   0    1G  0 disk 
├─vg_var-lv_var_rmeta_1    253:5    0    4M  0 lvm  
│ └─vg_var-lv_var          253:7    0  952M  0 lvm  /var
└─vg_var-lv_var_rimage_1   253:6    0  952M  0 lvm  
  └─vg_var-lv_var          253:7    0  952M  0 lvm  /var
sde                          8:64   0    1G  0 disk 

[vagrant@lvm ~]$ sudo lvs
  LV          VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  LogVol00    VolGroup00 -wi-ao----   8.00g                                                    
  LogVol01    VolGroup00 -wi-ao----   1.50g                                                    
  LogVol_Home VolGroup00 -wi-ao----   2.00g                                                    
  lv_var      vg_var     rwi-aor--- 952.00m                                    100.00          

[vagrant@lvm ~]$ cat /etc/fstab 
#
# /etc/fstab
# Created by anaconda on Sat May 12 18:50:26 2018
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/VolGroup00-LogVol00 /                       xfs     defaults        0 0
UUID=570897ca-e759-4c81-90cf-389da6eee4cc /boot                   xfs     defaults        0 0
/dev/mapper/VolGroup00-LogVol01 swap                    swap    defaults        0 0
UUID="c6eb10d2-92a6-46f8-91b3-c69e3bc1f72d"  /var ext4 defaults 0 0
UUID="84eae4f7-fe7b-4874-ba1d-84c852f5420a"  /home xfs defaults 0 0
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
#VAGRANT-END
```

Далее приступаем к тестированию работы snapshots:

1) Создаем файлы в директории `home`:

```BASH
[vagrant@lvm ~]$ ll /home/
total 0
-rw-r--r--. 1 root    root      0 May 28 15:43 file1
-rw-r--r--. 1 root    root      0 May 28 15:43 file10
-rw-r--r--. 1 root    root      0 May 28 15:43 file11
-rw-r--r--. 1 root    root      0 May 28 15:43 file12
-rw-r--r--. 1 root    root      0 May 28 15:43 file13
-rw-r--r--. 1 root    root      0 May 28 15:43 file14
-rw-r--r--. 1 root    root      0 May 28 15:43 file15
-rw-r--r--. 1 root    root      0 May 28 15:43 file16
-rw-r--r--. 1 root    root      0 May 28 15:43 file17
-rw-r--r--. 1 root    root      0 May 28 15:43 file18
-rw-r--r--. 1 root    root      0 May 28 15:43 file19
-rw-r--r--. 1 root    root      0 May 28 15:43 file2
-rw-r--r--. 1 root    root      0 May 28 15:43 file20
-rw-r--r--. 1 root    root      0 May 28 15:43 file3
-rw-r--r--. 1 root    root      0 May 28 15:43 file4
-rw-r--r--. 1 root    root      0 May 28 15:43 file5
-rw-r--r--. 1 root    root      0 May 28 15:43 file6
-rw-r--r--. 1 root    root      0 May 28 15:43 file7
-rw-r--r--. 1 root    root      0 May 28 15:43 file8
-rw-r--r--. 1 root    root      0 May 28 15:43 file9
drwx------. 3 vagrant vagrant 117 May 26 21:13 vagrant
```

2) Создаем snapshot

```BASH
[vagrant@lvm ~]$ sudo lvcreate -L 100MB -s -n home_snap /dev/VolGroup00/LogVol_Home
  Rounding up size to full physical extent 128.00 MiB
  Logical volume "home_snap" created.
```

3) Убеждаемся, что snapshot создан:

```BASH
[vagrant@lvm ~]$ lsblk
NAME                            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda                               8:0    0   40G  0 disk 
├─sda1                            8:1    0    1M  0 part 
├─sda2                            8:2    0    1G  0 part /boot
└─sda3                            8:3    0   39G  0 part 
  ├─VolGroup00-LogVol00         253:0    0    8G  0 lvm  /
  ├─VolGroup00-LogVol01         253:1    0  1.5G  0 lvm  [SWAP]
  ├─VolGroup00-LogVol_Home-real 253:8    0    2G  0 lvm  
  │ ├─VolGroup00-LogVol_Home    253:4    0    2G  0 lvm  /home
  │ └─VolGroup00-home_snap      253:10   0    2G  0 lvm  
  └─VolGroup00-home_snap-cow    253:9    0  128M  0 lvm  
    └─VolGroup00-home_snap      253:10   0    2G  0 lvm  
sdb                               8:16   0   10G  0 disk 
sdc                               8:32   0    2G  0 disk 
├─vg_var-lv_var_rmeta_0         253:2    0    4M  0 lvm  
│ └─vg_var-lv_var               253:7    0  952M  0 lvm  /var
└─vg_var-lv_var_rimage_0        253:3    0  952M  0 lvm  
  └─vg_var-lv_var               253:7    0  952M  0 lvm  /var
sdd                               8:48   0    1G  0 disk 
├─vg_var-lv_var_rmeta_1         253:5    0    4M  0 lvm  
│ └─vg_var-lv_var               253:7    0  952M  0 lvm  /var
└─vg_var-lv_var_rimage_1        253:6    0  952M  0 lvm  
  └─vg_var-lv_var               253:7    0  952M  0 lvm  /var
sde                               8:64   0    1G  0 disk 
```

4) Удалаяем несколько файлов:

```BASH
[vagrant@lvm ~]$ sudo rm -f /home/file{11..20}
[vagrant@lvm ~]$ ll /home/
total 0
-rw-r--r--. 1 root    root      0 May 28 15:43 file1
-rw-r--r--. 1 root    root      0 May 28 15:43 file10
-rw-r--r--. 1 root    root      0 May 28 15:43 file2
-rw-r--r--. 1 root    root      0 May 28 15:43 file3
-rw-r--r--. 1 root    root      0 May 28 15:43 file4
-rw-r--r--. 1 root    root      0 May 28 15:43 file5
-rw-r--r--. 1 root    root      0 May 28 15:43 file6
-rw-r--r--. 1 root    root      0 May 28 15:43 file7
-rw-r--r--. 1 root    root      0 May 28 15:43 file8
-rw-r--r--. 1 root    root      0 May 28 15:43 file9
drwx------. 3 vagrant vagrant 117 May 26 21:13 vagrant
```

5) Восстанавливаем содержание папки `home`

```BASH
[vagrant@lvm ~]$ sudo umount /home
umount: /home: target is busy.
        (In some cases useful info about processes that use
         the device is found by lsof(8) or fuser(1))
[vagrant@lvm ~]$ cd /
[vagrant@lvm /]$ sudo umount /home

[vagrant@lvm /]$ sudo lvconvert --merge /dev/VolGroup00/home_snap
  Merging of volume VolGroup00/home_snap started.
  VolGroup00/LogVol_Home: Merged: 100.00%

[vagrant@lvm /]$ sudo mount /home
[vagrant@lvm /]$ ll /home/
total 0
-rw-r--r--. 1 root    root      0 May 28 15:43 file1
-rw-r--r--. 1 root    root      0 May 28 15:43 file10
-rw-r--r--. 1 root    root      0 May 28 15:43 file11
-rw-r--r--. 1 root    root      0 May 28 15:43 file12
-rw-r--r--. 1 root    root      0 May 28 15:43 file13
-rw-r--r--. 1 root    root      0 May 28 15:43 file14
-rw-r--r--. 1 root    root      0 May 28 15:43 file15
-rw-r--r--. 1 root    root      0 May 28 15:43 file16
-rw-r--r--. 1 root    root      0 May 28 15:43 file17
-rw-r--r--. 1 root    root      0 May 28 15:43 file18
-rw-r--r--. 1 root    root      0 May 28 15:43 file19
-rw-r--r--. 1 root    root      0 May 28 15:43 file2
-rw-r--r--. 1 root    root      0 May 28 15:43 file20
-rw-r--r--. 1 root    root      0 May 28 15:43 file3
-rw-r--r--. 1 root    root      0 May 28 15:43 file4
-rw-r--r--. 1 root    root      0 May 28 15:43 file5
-rw-r--r--. 1 root    root      0 May 28 15:43 file6
-rw-r--r--. 1 root    root      0 May 28 15:43 file7
-rw-r--r--. 1 root    root      0 May 28 15:43 file8
-rw-r--r--. 1 root    root      0 May 28 15:43 file9
drwx------. 3 vagrant vagrant 117 May 26 21:13 vagrant
```

6) Убеждаемся, что snapshot удален:

```BASH
[vagrant@lvm /]$ lsblk
NAME                       MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda                          8:0    0   40G  0 disk 
├─sda1                       8:1    0    1M  0 part 
├─sda2                       8:2    0    1G  0 part /boot
└─sda3                       8:3    0   39G  0 part 
  ├─VolGroup00-LogVol00    253:0    0    8G  0 lvm  /
  ├─VolGroup00-LogVol01    253:1    0  1.5G  0 lvm  [SWAP]
  └─VolGroup00-LogVol_Home 253:4    0    2G  0 lvm  /home
sdb                          8:16   0   10G  0 disk 
sdc                          8:32   0    2G  0 disk 
├─vg_var-lv_var_rmeta_0    253:2    0    4M  0 lvm  
│ └─vg_var-lv_var          253:7    0  952M  0 lvm  /var
└─vg_var-lv_var_rimage_0   253:3    0  952M  0 lvm  
  └─vg_var-lv_var          253:7    0  952M  0 lvm  /var
sdd                          8:48   0    1G  0 disk 
├─vg_var-lv_var_rmeta_1    253:5    0    4M  0 lvm  
│ └─vg_var-lv_var          253:7    0  952M  0 lvm  /var
└─vg_var-lv_var_rimage_1   253:6    0  952M  0 lvm  
  └─vg_var-lv_var          253:7    0  952M  0 lvm  /var
sde                          8:64   0    1G  0 disk 
[vagrant@lvm /]$ 
```
